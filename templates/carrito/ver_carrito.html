{% extends 'base.html' %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="bg-light py-2">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'productos:home' %}">Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">Carrito de Compras</li>
        </ol>
    </div>
</nav>

<!-- Carrito de Compras -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-shopping-cart me-2"></i>Carrito de Compras</h1>
                    {% if items %}
                    <button class="btn btn-outline-danger btn-sm" onclick="limpiarCarrito()">
                        <i class="fas fa-trash me-1"></i>Limpiar Carrito
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if items %}
        <div class="row">
            <!-- Items del Carrito -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Productos en tu carrito ({{ carrito.total_items }} item{{ carrito.total_items|pluralize }})</h5>
                    </div>
                    <div class="card-body p-0">
                        {% for item in items %}
                        <div class="cart-item border-bottom p-3" data-item-id="{{ item.id }}">
                            <div class="row align-items-center">
                                <!-- Imagen del Producto -->
                                <div class="col-md-2 col-3">
                                    <a href="{% url 'productos:detalle' item.producto.slug %}">
                                        {% if item.producto.imagenes.first %}
                                        <img src="{{ item.producto.imagenes.first.imagen.url }}" 
                                             class="img-fluid rounded" alt="{{ item.producto.nombre }}"
                                             style="height: 80px; object-fit: cover;">
                                        {% else %}
                                        <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                             style="height: 80px;">
                                            <i class="fas fa-tools text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </a>
                                </div>

                                <!-- Información del Producto -->
                                <div class="col-md-4 col-9">
                                    <h6 class="mb-1">
                                        <a href="{% url 'productos:detalle' item.producto.slug %}" 
                                           class="text-decoration-none text-dark">
                                            {{ item.producto.nombre }}
                                        </a>
                                    </h6>
                                    <small class="text-muted d-block">Código: {{ item.producto.codigo }}</small>
                                    {% if item.producto.marca %}
                                    <small class="text-muted">{{ item.producto.marca.nombre }}</small>
                                    {% endif %}
                                    
                                    <!-- Disponibilidad -->
                                    <div class="mt-2">
                                        {% if item.producto.disponible %}
                                        <small class="text-success">
                                            <i class="fas fa-check-circle"></i> Disponible
                                        </small>
                                        {% else %}
                                        <small class="text-danger">
                                            <i class="fas fa-exclamation-triangle"></i> No disponible
                                        </small>
                                        {% endif %}
                                        
                                        {% if item.cantidad > item.producto.stock %}
                                        <small class="text-warning d-block">
                                            <i class="fas fa-exclamation-triangle"></i> 
                                            Solo hay {{ item.producto.stock }} unidades disponibles
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Precio Unitario -->
                                <div class="col-md-2 col-6 text-center">
                                    <div class="precio-unitario">
                                        <strong>${{ item.precio_unitario|floatformat:0 }}</strong>
                                        {% if item.producto.tiene_oferta and item.precio_unitario != item.producto.precio %}
                                        <br><small class="text-muted"><del>${{ item.producto.precio|floatformat:0 }}</del></small>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Cantidad -->
                                <div class="col-md-2 col-6">
                                    <div class="input-group input-group-sm">
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="cambiarCantidad({{ item.id }}, {{ item.cantidad }} - 1)">
                                            -
                                        </button>
                                        <input type="number" class="form-control text-center cantidad-input" 
                                               value="{{ item.cantidad }}" min="1" max="{{ item.producto.stock }}"
                                               data-item-id="{{ item.id }}" onchange="actualizarCantidad({{ item.id }}, this.value)">
                                        <button class="btn btn-outline-secondary" type="button" 
                                                onclick="cambiarCantidad({{ item.id }}, {{ item.cantidad }} + 1)">
                                            +
                                        </button>
                                    </div>
                                    <small class="text-muted">Stock: {{ item.producto.stock }}</small>
                                </div>

                                <!-- Subtotal -->
                                <div class="col-md-1 col-6 text-end">
                                    <strong class="item-subtotal">${{ item.subtotal|floatformat:0 }}</strong>
                                </div>

                                <!-- Eliminar -->
                                <div class="col-md-1 col-6 text-end">
                                    <button class="btn btn-outline-danger btn-sm" 
                                            onclick="eliminarItem({{ item.id }})" title="Eliminar producto">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Continuar Comprando -->
                <div class="mt-3">
                    <a href="{% url 'productos:catalogo' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Continuar Comprando
                    </a>
                </div>
            </div>

            <!-- Resumen del Carrito -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">Resumen del Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal ({{ carrito.total_items }} item{{ carrito.total_items|pluralize }}):</span>
                            <span class="carrito-subtotal">${{ carrito.subtotal|floatformat:0 }}</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Envío:</span>
                            <span class="text-muted">A calcular</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Impuestos:</span>
                            <span class="text-muted">Incluidos</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong class="fs-4 text-primary carrito-total">${{ carrito.total|floatformat:0 }}</strong>
                        </div>

                        <!-- Información de Envío -->
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Envío gratis en compras superiores a $50.000
                            </small>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" onclick="procederCheckout()">
                                <i class="fas fa-credit-card me-2"></i>
                                Proceder al Checkout
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>
                                Imprimir Carrito
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Productos Recomendados -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">También te puede interesar</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- TODO: Agregar productos recomendados -->
                            <div class="col-12 text-center text-muted">
                                <i class="fas fa-lightbulb fa-2x mb-2"></i>
                                <p>Próximamente productos recomendados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% else %}
        <!-- Carrito Vacío -->
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-shopping-cart fa-5x text-muted"></i>
                    </div>
                    <h3>Tu carrito está vacío</h3>
                    <p class="text-muted mb-4">¡Descubre nuestros productos y comienza a comprar!</p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'productos:catalogo' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-tools me-2"></i>Ver Catálogo
                        </a>
                        <a href="{% url 'productos:home' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-home me-2"></i>Ir al Inicio
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Modal de Confirmación -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Acción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¿Estás seguro de realizar esta acción?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.cart-item:hover {
    background-color: #f8f9fa;
}

.cantidad-input {
    width: 60px;
}

@media print {
    .btn, .navbar, .breadcrumb {
        display: none !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
    }
}

.sticky-top {
    z-index: 1020;
}

.alert-info {
    border-left: 4px solid #0dcaf0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let confirmModal;
let pendingAction = null;

// Inicializar modal
document.addEventListener('DOMContentLoaded', function() {
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
});

// Cambiar cantidad con botones +/-
function cambiarCantidad(itemId, nuevaCantidad) {
    if (nuevaCantidad < 1) {
        eliminarItem(itemId);
        return;
    }
    
    const input = document.querySelector(`input[data-item-id="${itemId}"]`);
    const maxStock = parseInt(input.getAttribute('max'));
    
    if (nuevaCantidad > maxStock) {
        mostrarAlerta('No hay suficiente stock disponible', 'warning');
        return;
    }
    
    input.value = nuevaCantidad;
    actualizarCantidad(itemId, nuevaCantidad);
}

// Actualizar cantidad
function actualizarCantidad(itemId, cantidad) {
    const formData = new FormData();
    formData.append('cantidad', cantidad);
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    
    fetch(`/carrito/actualizar/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            actualizarUICarrito(data);
            
            // Actualizar subtotal del item
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
            if (itemElement && data.item_subtotal) {
                const subtotalElement = itemElement.querySelector('.item-subtotal');
                if (subtotalElement) {
                    subtotalElement.textContent = `$${parseInt(data.item_subtotal).toLocaleString()}`;
                }
            }
            
            mostrarAlerta(data.message, 'success');
        } else {
            mostrarAlerta(data.message, 'error');
            // Revertir el valor del input
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('Error al actualizar el carrito', 'error');
        location.reload();
    });
}

// Eliminar item
function eliminarItem(itemId) {
    document.getElementById('confirmMessage').textContent = '¿Estás seguro de eliminar este producto del carrito?';
    pendingAction = () => {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch(`/carrito/eliminar/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remover el elemento del DOM
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemElement) {
                    itemElement.remove();
                }
                
                actualizarUICarrito(data);
                mostrarAlerta(data.message, 'success');
                
                // Si no hay más items, recargar la página para mostrar carrito vacío
                if (data.carrito_count == 0) {
                    setTimeout(() => location.reload(), 1000);
                }
            } else {
                mostrarAlerta(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error al eliminar el producto', 'error');
        });
    };
    
    confirmModal.show();
}

// Limpiar carrito
function limpiarCarrito() {
    document.getElementById('confirmMessage').textContent = '¿Estás seguro de limpiar todo el carrito?';
    pendingAction = () => {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch('/carrito/limpiar/', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                mostrarAlerta(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error al limpiar el carrito', 'error');
        });
    };
    
    confirmModal.show();
}

// Proceder al checkout
function procederCheckout() {
    // TODO: Implementar checkout
    mostrarAlerta('Función de checkout en desarrollo', 'info');
}

// Actualizar UI del carrito
function actualizarUICarrito(data) {
    // Actualizar contador en navbar
    const carritoCount = document.querySelector('.navbar .badge');
    if (carritoCount) {
        carritoCount.textContent = data.carrito_count;
    }
    
    // Actualizar totales
    const subtotalElement = document.querySelector('.carrito-subtotal');
    const totalElement = document.querySelector('.carrito-total');
    
    if (subtotalElement) {
        subtotalElement.textContent = `$${parseInt(data.carrito_total).toLocaleString()}`;
    }
    if (totalElement) {
        totalElement.textContent = `$${parseInt(data.carrito_total).toLocaleString()}`;
    }
}

// Mostrar alertas
function mostrarAlerta(mensaje, tipo) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass[tipo]} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Auto-dismiss después de 5 segundos
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Confirmar acción en modal
document.getElementById('confirmButton').addEventListener('click', function() {
    if (pendingAction) {
        pendingAction();
        pendingAction = null;
    }
    confirmModal.hide();
});

// Validar inputs de cantidad
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('cantidad-input')) {
        const max = parseInt(e.target.getAttribute('max'));
        const min = parseInt(e.target.getAttribute('min'));
        let value = parseInt(e.target.value);
        
        if (value > max) {
            e.target.value = max;
        } else if (value < min) {
            e.target.value = min;
        }
    }
});
</script>
{% endblock %}